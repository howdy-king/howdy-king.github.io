---
layout:     post
title:      内网和外网之间的通信
subtitle:   网络
date:       2020-05-19
author:     TL
header-img: img/home-bg-1.jpeg
catalog: true
tags:
    - 网络
---

## 内网和外网之间的通信（端口映射原理）

【转自】https://www.cnblogs.com/ranyonsue/p/9713992.html

#### “内网”与“外网”的概念：

   内网：即所说的局域网，比如学校的局域网，局域网内每台计算机的IP地址在本局域网内具有互异性，是不可重复的。**但两个局域网内的内网IP可以有相同的。**

  外网：即互联网，局域网通过一台服务器或是一个路由器对外连接的网络，**这个IP地址是惟一的**。也就是说内网里所有的计算机都是连接到这一个外网IP上，通过这一个外网IP对外进行交换数据的。一个局域网里所有电脑的内网IP是互不相同的,但共用一个外网IP。（用ipconfig查到的IP是你本机的内网IP；在[www.ip138.com](http://www.ip138.com/)上看到的是你连接互联网所使用的IP，即外网）。

在局域网中，每台电脑都可以自己分配自己的IP，这个IP只在局域网中有效。而如果你将电脑连接到互联网，你的网络提供商（ISP）的服务器会为你分配一个IP地址，这个IP地址才是你在外网的IP。两个IP同时存在，一个对内，一个对外。

在内网的主机上网时，都是在向网关发出请求，再由网关（一般为路由器）用外网IP转到INT网上，收到数据后，再分发到你的内网IP上。

#### **公有 IP 和私有 IP 的区别**

　首先，我们需要了解一下什么是公有 IP 和私有 IP ?

> 公有地址(Public address)：由 Inter NIC(Internet Network Information Center 因特网信息中心)负责。这些 IP 地址分配给注册并向Inter NIC提出申请的组织机构，公有 IP 全球唯一，通过它直接访问因特网(直接能上网)。

> 私有地址(Private address)：属于非注册地址，专门为组织机构内部使用，说白了，私有 IP 不能直接上网。

​     而我们平时通过运营商(电信、移动、联通宽带等)上网，家里面通过路由器分出来的 IP 都是私有 IP(局域网 IP)，大家可能会疑问，我们可以上网啊，怎么会是私有 IP 呢?租用(申请)公有 IP 是需要钱的。 运营商买了一些公有 IP，然后通过这些公有 IP 分出来，再分给一个一个的用户使用。这个过程有点类似于，我们去安装了宽度，通过路由器分出几个 IP，让好几个人都能上网，当然运营商通过公有 IP 分出来的过程肯定比这个复杂多了。所以，我们平时上网用的 IP 是私有 IP，真正拥有公有 IP 的是运营商(当然，我们可以租用一个公有 IP )。所以，A 家庭的局域网 IP 和 B 家庭的局域网 IP 相同很正常，但是，最终 A 和 B 能上网(数据走出去)还是通过运营商的公有 IP，毕竟，公有 IP 的资源有限，这一片区域的用户使用的很有可能(实际上就是这样的)是同一个公有 IP。

#### **端口映射**

　　端口映射是 NAT 的一种，它将外网主机的 IP 地址的一个端口映射到内网中一台机器，提供相应的服务。当用户访问该 IP 的这个端口时，服务器自动将请求映射到对应局域网内部的机器上。

　　我们平时经过路由器，通过宽带，最终去到运营商那边，数据是从运营商出去，最终数据是回到运营商那边，运营商再把数据发送到用户的电脑。

　　路由器，至少有两个端口：WAN 口和 LAN 口。

　　WAN：接外部 IP 地址用，通常指的是出口，转发来自内部 LAN 接口的 IP 数据包，这个口的 IP 是唯一的。

　　LAN：接内部 IP 地址用，LAN 内部是交换机。

为了方便大家理解，我们把 IP 的转化方向反过来分析(准确来说，公网转局域网)。

　　A 电脑的 IP 是局域网 IP(192.168.31.11)，这个 IP(192.168.31.11)是从路由器的 lan口分配的。

　　当我们上百度的时候，经过路由器的 wan口，进行相应的IP、端口转化：192.168.31.11:80 -> 10.221.0.24:8080,所以，从 wan口出去的地址为：10.221.0.24:8080。

最后，经过运营商，运营商那边会做相应的端口映射(而且是动态端口映射)，子网 IP(10.221.0.24:8080)转化为公网 IP(128.0.0.1:8888)，通过这个公网 IP 去访问百度服务器。

同理，B 的过程也是一样。通过这样的层层端口映射，最终保证地址(IP + 端口)的唯一性。A 和 B 访问百度服务器，尽管它们的局域网 IP 是一样的，但是最终它们访问百度的地址(IP + 端口)是唯一的，所以，百度服务器回复时，原路返回时能够区分到底给谁回。